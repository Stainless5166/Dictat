#cloud-config
# Cloud-init configuration for Digital Ocean droplet
# TODO Phase 5: Customize for production deployment

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - wget
  - ufw
  - fail2ban

# Create dictat user
users:
  - name: dictat
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# Mount block storage volume
mounts:
  - ["/dev/disk/by-id/scsi-0DO_Volume_dictat-storage-production", "/mnt/dictat-storage", "ext4", "defaults,nofail,discard", "0", "2"]

write_files:
  # Docker daemon configuration
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        }
      }

runcmd:
  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # Create directories
  - mkdir -p /mnt/dictat-storage/audio
  - mkdir -p /mnt/dictat-storage/postgres
  - mkdir -p /mnt/dictat-storage/redis
  - mkdir -p /app
  - chown -R dictat:dictat /mnt/dictat-storage /app

  # Start Docker
  - systemctl start docker
  - systemctl enable docker

  # TODO: Clone repository and start application
  # - su - dictat -c "cd /app && git clone https://github.com/yourusername/dictat.git"
  # - su - dictat -c "cd /app/dictat && docker-compose up -d"

# Reboot after setup
power_state:
  mode: reboot
  timeout: 300
  condition: true
